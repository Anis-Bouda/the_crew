import java.awt.*;
import java.awt.datatransfer.StringSelection;
import java.awt.datatransfer.Transferable;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.net.URL;
import javax.swing.*;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.tree.*;

public class ComposantPanel extends JPanel {
    private String activeTool = "None";
    private JTree tree; // DÃ©clare l'arbre au niveau de la classe

    public ComposantPanel() {
        setLayout(new BorderLayout());

        // ğŸ”¹ CrÃ©ation du nÅ“ud racine
        DefaultMutableTreeNode root = new DefaultMutableTreeNode("Composants");

        // ğŸ”¹ CrÃ©ation des catÃ©gories
        DefaultMutableTreeNode Gates = new DefaultMutableTreeNode("Gates");
        DefaultMutableTreeNode Perxers = new DefaultMutableTreeNode("Perxers");
        DefaultMutableTreeNode Memory = new DefaultMutableTreeNode("Memory");
        DefaultMutableTreeNode Arithmetic = new DefaultMutableTreeNode("Arithmetic");
        DefaultMutableTreeNode Wirray = new DefaultMutableTreeNode("Wirray");

        // ğŸ”¹ Ajout des catÃ©gories au nÅ“ud racine
        root.add(Gates);
        root.add(Perxers);
        root.add(Memory);
        root.add(Arithmetic);
        root.add(Wirray);

        // ğŸ”¹ Ajout des sous-composants
        Gates.add(new DefaultMutableTreeNode("NOT"));
        Gates.add(new DefaultMutableTreeNode("OR"));
        Gates.add(new DefaultMutableTreeNode("AND"));
        Gates.add(new DefaultMutableTreeNode("BUFFER"));
        Gates.add(new DefaultMutableTreeNode("NOR"));
        Gates.add(new DefaultMutableTreeNode("XOR"));
        Gates.add(new DefaultMutableTreeNode("XNOR"));
        Gates.add(new DefaultMutableTreeNode("NAND"));

        Perxers.add(new DefaultMutableTreeNode("Multiplexer"));
        Perxers.add(new DefaultMutableTreeNode("Demultiplexer"));
        Perxers.add(new DefaultMutableTreeNode("Decoder"));

        Memory.add(new DefaultMutableTreeNode("D flip flop"));
        Memory.add(new DefaultMutableTreeNode("T flip flop"));

        Arithmetic.add(new DefaultMutableTreeNode("Adder"));
        Arithmetic.add(new DefaultMutableTreeNode("Subtractor"));

        // ğŸ”¹ Ajout des outils Wirray avec noms corrigÃ©s
        Wirray.add(new DefaultMutableTreeNode("Poke Tool"));
        Wirray.add(new DefaultMutableTreeNode("Edit Tool"));  // âœ… Suppression de lâ€™espace en trop
        Wirray.add(new DefaultMutableTreeNode("Select Tool"));
        Wirray.add(new DefaultMutableTreeNode("Writing Tool"));
        Wirray.add(new DefaultMutableTreeNode("Text Tool"));
        Wirray.add(new DefaultMutableTreeNode("OutPut"));

        // ğŸ”¹ CrÃ©ation de l'arbre JTree
        tree = new JTree(new DefaultTreeModel(root));

        // ğŸ¯ Ajout du listener pour dÃ©tecter le clic sur un Ã©lÃ©ment
        tree.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                int row = tree.getRowForLocation(e.getX(), e.getY());
                if (row == -1) return; // Aucun Ã©lÃ©ment sÃ©lectionnÃ©

                DefaultMutableTreeNode selectedNode = (DefaultMutableTreeNode) tree.getLastSelectedPathComponent();
                if (selectedNode == null || !selectedNode.isLeaf()) return; // Ignore les catÃ©gories

                String nodeName = selectedNode.getUserObject().toString();

                // VÃ©rifier si l'Ã©lÃ©ment cliquÃ© appartient Ã  "Wirray"
                switch (nodeName) {
                    case "Poke Tool" -> activatePokeTool();
                    case "Edit Tool" -> activateEditTool();
                    case "Select Tool" -> activateSelectTool();
                    case "Writing Tool" -> activateWritingTool();
                    case "Text Tool" -> activateTextTool();
                    case "OutPut" -> activateOutputTool();
                }

                System.out.println("Outil activÃ© : " + nodeName);
            }
        });

        // ğŸ”¹ Active le glisser-dÃ©poser sur l'arbre
        tree.setDragEnabled(true);
        tree.setTransferHandler(new TransferHandler() {
            @Override
            public int getSourceActions(JComponent c) {
                return COPY;
            }

            @Override
            protected Transferable createTransferable(JComponent c) {
                DefaultMutableTreeNode node = (DefaultMutableTreeNode) tree.getLastSelectedPathComponent();
                if (node == null) return null;
                return new StringSelection(node.getUserObject().toString());
            }
        });

        tree.setCellRenderer(new ComposantTreeCellRenderer());

        // ğŸ”¹ Ajout du dÃ©filement
        JScrollPane scrollPane = new JScrollPane(tree);
        scrollPane.setPreferredSize(new Dimension(300, 250));

        // ğŸ”¹ Ajout de l'arbre au panneau
        add(scrollPane, BorderLayout.CENTER);
    }

    // ğŸ”¥ Ajout des outils avec changement de curseur
    private void activatePokeTool() {
        activeTool = "Poke Tool";
        tree.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR)); // ğŸ– Curseur main
    }

    private void activateEditTool() {
        activeTool = "Edit Tool";
        tree.setCursor(Cursor.getPredefinedCursor(Cursor.TEXT_CURSOR)); // ğŸ“ Curseur texte
    }

    private void activateSelectTool() {
        activeTool = "Select Tool";
        tree.setCursor(Cursor.getPredefinedCursor(Cursor.CROSSHAIR_CURSOR)); // ğŸ¯ Curseur croix
    }

    private void activateWritingTool() {
        activeTool = "Writing Tool";
        tree.setCursor(Cursor.getPredefinedCursor(Cursor.TEXT_CURSOR)); // ğŸ–Šï¸ Curseur texte
    }

    private void activateTextTool() {
        activeTool = "Text Tool";
        tree.setCursor(Cursor.getPredefinedCursor(Cursor.TEXT_CURSOR)); // âœï¸ Curseur texte
    }

    private void activateOutputTool() {
        activeTool = "OutPut";
        tree.setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR)); // ğŸ”„ Curseur normal
    }

    // ğŸ”¹ Classe interne pour personnaliser l'affichage des icÃ´nes
    static class ComposantTreeCellRenderer extends DefaultTreeCellRenderer {
        private Icon resizeIcon(String path, int width, int height) {
            URL resource = getClass().getResource(path);
            if (resource == null) {
                System.err.println("âš ï¸ Image not found: " + path);
                return new ImageIcon();
            }

            ImageIcon originalIcon = new ImageIcon(resource);
            Image resizedImage = originalIcon.getImage().getScaledInstance(width, height, Image.SCALE_SMOOTH);
            return new ImageIcon(resizedImage);
        }

        @Override
        public Component getTreeCellRendererComponent(JTree tree, Object value, boolean selected,
                                                      boolean expanded, boolean leaf, int row, boolean hasFocus) {
            super.getTreeCellRendererComponent(tree, value, selected, expanded, leaf, row, hasFocus);
            return this;
        }
    }
}
